<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tạo mã QR - Nhật Đăng</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="../logo.png" type="image/png">
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:linear-gradient(90deg,#a1c4fd,#c2e9fb);gap:18px;padding:24px;
    }
    h1{margin:0;color:#0b2940;font-size:clamp(18px,4vw,32px)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    input[type="text"]{
      padding:10px 12px;border-radius:10px;border:0;min-width:200px;font-size:14px;max-width:60vw
    }
    button{
      padding:10px 14px;border-radius:10px;border:0;background:#00c6ff;color:#fff;cursor:pointer;font-weight:600
    }
    button.secondary{background:#fff;color:#0072ff;border:1px solid rgba(0,114,255,0.12)}

    /* KHÔNG cho canvas bị co giãn lệch */
    #qr-wrap{
      border-radius:24px;
      padding:16px;
      background:linear-gradient(#ffffff, #f7fbff);
      box-shadow:0 6px 20px rgba(10,30,60,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    canvas{
      display:block;
      width:auto !important;  
      height:auto !important; 
      max-width:80vw;
      max-height:80vw; /* luôn vuông */
      aspect-ratio:1/1;
      border-radius:12px;
    }

    @media (max-width:520px){
      input[type="text"]{min-width:140px;font-size:13px}
      button{padding:10px 12px;font-size:13px}
    }
  </style>
</head>
<body>
  <h1>Tạo mã QR - Nhật Đăng</h1>

  <div class="controls">
    <input id="text" type="text" placeholder="Nhập nội dung..." />
    <button onclick="generateQRCode()">Tạo mã QR</button>
    <button class="secondary" onclick="downloadQR()">Tải ảnh</button>
  </div>

  <div id="qr-wrap">
    <canvas id="qr-canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

  <script>
    const canvas = document.getElementById('qr-canvas');
    const ctx = canvas.getContext('2d');
    let lastQR = null;

    function generateQRCode() {
      const text = document.getElementById('text').value.trim();
      if (!text) { alert('Vui lòng nhập nội dung.'); return; }

      const qr = qrcode(0, 'H');
      qr.addData(text);
      qr.make();
      lastQR = qr;

      drawRoundedQR(qr);
    }

    function drawRoundedQR(qr, opts = {}) {
      const moduleCount = qr.getModuleCount();
      const paddingModules = 4;

      // Luôn tạo QR size cố định 420px * 420px (vuông chuẩn)
      const desired = 420;
      const totalModules = moduleCount + paddingModules * 2;
      const moduleSize = Math.floor(desired / totalModules);
      const canvasSize = moduleSize * totalModules;

      const ratio = window.devicePixelRatio || 1;
      canvas.width = canvasSize * ratio;
      canvas.height = canvasSize * ratio;
      canvas.style.width = canvasSize + "px";
      canvas.style.height = canvasSize + "px";

      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      ctx.clearRect(0, 0, canvasSize, canvasSize);

      // background
      roundRect(ctx, 0, 0, canvasSize, canvasSize, 28);
      ctx.fillStyle = "#ffffff";
      ctx.fill();

      const offset = paddingModules * moduleSize;
      const darkColor = "#0b2540";

      ctx.fillStyle = darkColor;

      const radius = moduleSize * 0.38;

      for (let r = 0; r < moduleCount; r++) {
        for (let c = 0; c < moduleCount; c++) {
          if (!qr.isDark(r, c)) continue;
          const x = offset + c * moduleSize;
          const y = offset + r * moduleSize;
          roundRect(ctx, x, y, moduleSize, moduleSize, radius);
          ctx.fill();
        }
      }

      drawFinderPattern(qr, 0, 0, moduleSize, offset);
      drawFinderPattern(qr, 0, moduleCount - 7, moduleSize, offset);
      drawFinderPattern(qr, moduleCount - 7, 0, moduleSize, offset);
    }

    function roundRect(ctx, x, y, w, h, r) {
      r = Math.min(r, Math.min(w, h) / 2);
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
    }

    function drawFinderPattern(qr, row, col, moduleSize, offset) {
      const x = offset + col * moduleSize;
      const y = offset + row * moduleSize;
      const size = 7 * moduleSize;

      roundRect(ctx, x, y, size, size, moduleSize * 1.2);
      ctx.fillStyle = '#0b2540';
      ctx.fill();

      const gap = moduleSize;
      roundRect(ctx, x + gap, y + gap, size - 2 * gap, size - 2 * gap, moduleSize * 0.8);
      ctx.fillStyle = '#ffffff';
      ctx.fill();

      const cx = x + gap * 2;
      const cy = y + gap * 2;
      const csize = 3 * moduleSize;
      roundRect(ctx, cx, cy, csize, csize, moduleSize * 0.6);
      ctx.fillStyle = '#0b2540';
      ctx.fill();
    }

    function downloadQR() {
      if (!lastQR) { alert("Bạn chưa tạo mã QR."); return; }

      const paddingModules = 4;
      const moduleCount = lastQR.getModuleCount();
      const exportSize = 1200;
      const totalModules = moduleCount + paddingModules * 2;
      const moduleSize = Math.floor(exportSize / totalModules);
      const finalSize = moduleSize * totalModules;

      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = finalSize;
      exportCanvas.height = finalSize;

      const ectx = exportCanvas.getContext("2d");

      roundRect(ectx, 0, 0, finalSize, finalSize, finalSize * 0.06);
      ectx.fillStyle = "#ffffff";
      ectx.fill();

      const offset = paddingModules * moduleSize;
      ectx.fillStyle = "#0b2540";

      const radius = moduleSize * 0.36;

      for (let r = 0; r < moduleCount; r++) {
        for (let c = 0; c < moduleCount; c++) {
          if (!lastQR.isDark(r, c)) continue;
          const x = offset + c * moduleSize;
          const y = offset + r * moduleSize;
          roundRect(ectx, x, y, moduleSize, moduleSize, radius);
          ectx.fill();
        }
      }

      drawFinderPatternExport(ectx, lastQR, 0, 0, moduleSize, offset);
      drawFinderPatternExport(ectx, lastQR, 0, moduleCount - 7, moduleSize, offset);
      drawFinderPatternExport(ectx, lastQR, moduleCount - 7, 0, moduleSize, offset);

      const link = document.createElement("a");
      link.href = exportCanvas.toDataURL("image/png");
      link.download = "nd-site-qr-code.png";
      link.click();
    }

    function drawFinderPatternExport(ectx, qr, row, col, moduleSize, offset) {
      const x = offset + col * moduleSize;
      const y = offset + row * moduleSize;
      const size = 7 * moduleSize;

      roundRect(ectx, x, y, size, size, moduleSize * 1.2);
      ectx.fillStyle = "#0b2540";
      ectx.fill();

      const gap = moduleSize;
      roundRect(ectx, x + gap, y + gap, size - 2 * gap, size - 2 * gap, moduleSize * 0.8);
      ectx.fillStyle = "#ffffff";
      ectx.fill();

      const cx = x + gap * 2;
      const cy = y + gap * 2;
      const csize = 3 * moduleSize;
      roundRect(ectx, cx, cy, csize, csize, moduleSize * 0.6);
      ectx.fillStyle = "#0b2540";
      ectx.fill();
    }
  </script>
</body>
</html>
