<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m ki·∫øm - ND Labs</title>
    <link rel="icon" href="/logo.png" type="image/png">
    
    <script async src="https://cse.google.com/cse.js?cx=90bdd5f1afd434b9d"></script>

    <style>
        :root {
            --blue-main: #00a8ff;
            --blue-dark: #0077ff;
            --bg: #f8fbff;
            --white: #ffffff;
            --tag-bg: #e1f5fe;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; overflow: auto !important; }
        header { background: var(--white); padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .brand { display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none; font-size: 1.5rem; font-weight: 800; color: var(--blue-dark); }
        .container { max-width: 800px; margin: 0 auto; padding: 0 15px; }

        .search-area { position: sticky; top: 70px; background: var(--bg); padding: 15px 0; z-index: 999; }
        #status { font-size: 0.85rem; text-align: center; color: var(--blue-dark); margin-bottom: 10px; }
        input { width: 100%; padding: 14px 25px; border-radius: 50px; border: 2px solid var(--blue-main); outline: none; font-size: 16px; box-shadow: 0 8px 20px rgba(0,168,255,0.1); }

        /* K·∫æT QU·∫¢ N·ªòI B·ªò V√Ä TH·∫∫ SITE */
        .result-item { background: var(--white); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 6px solid var(--blue-main); text-decoration: none; display: block; position: relative; }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .title { color: var(--blue-dark); font-weight: bold; font-size: 1.1rem; flex: 1; }
        .site-tag { 
            background: var(--tag-bg); color: var(--blue-dark); 
            font-size: 0.7rem; font-weight: bold; padding: 4px 10px; 
            border-radius: 20px; text-transform: uppercase; margin-left: 10px;
            white-space: nowrap; border: 1px solid rgba(0,168,255,0.2);
        }
        .snippet { color: #666; font-size: 0.85rem; line-height: 1.5; }

        /* Th√¥ng b√°o */
        .sorry-box { background: #fff5f5; border: 1px dashed #ff4757; padding: 20px; border-radius: 15px; color: #d63031; margin: 20px 0; text-align: center; }

        /* Google Section */
        .google-header { font-size: 0.9rem; font-weight: bold; color: #7f8c8d; margin: 30px 0 10px 0; display: flex; align-items: center; gap: 10px; }
        .google-header::after { content: ""; flex: 1; height: 1px; background: #ddd; }

        /* DI·ªÜT OVERLAY GOOGLE */
        .gsc-modal-background-wide { display: none !important; }
        .gsc-results-wrapper-overlay { position: relative !important; top: auto !important; left: auto !important; width: 100% !important; display: block !important; box-shadow: none !important; background: transparent !important; z-index: 1 !important; }
        body.gsc-overflow-hidden { overflow: auto !important; position: static !important; }
        .gsc-results-close-btn, .gsc-search-box, .gsc-adBlock { display: none !important; }
        .gsc-control-cse { background-color: transparent !important; border: none !important; padding: 0 !important; }
    </style>
</head>
<body>

<header>
    <a href="/" class="brand"><span>ND Labs</span></a>
</header>

<div class="container">
    <div class="search-area">
        <div id="status">ƒêang n·∫°p d·ªØ li·ªáu...</div>
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm trong repo & web..." disabled>
    </div>
    
    <div id="internalResults"></div>

    <div id="googleSection" style="display:none;">
        <div class="google-header">K·∫øt qu·∫£ t·ª´ Google Web</div>
        <div class="gcse-searchresults-only" data-gname="nd-engine"></div>
    </div>
</div>

<script>
    const CONFIG = {
        username: 'nd-site',
        repositories: ['nd-site.github.io', 'test', 'windows12', 'eduspace', 'hoctap'],
        branch: 'main',
        cacheTime: 24 * 60 * 60 * 1000 
    };

    let searchDatabase = [];
    const searchInput = document.getElementById('searchInput');
    const internalResults = document.getElementById('internalResults');
    const googleSection = document.getElementById('googleSection');

    function getCache() {
        const cached = localStorage.getItem('nd_search_cache');
        if (!cached) return null;
        const data = JSON.parse(cached);
        return (Date.now() - data.timestamp) > CONFIG.cacheTime ? null : data.database;
    }
    function setCache(db) { localStorage.setItem('nd_search_cache', JSON.stringify({timestamp: Date.now(), database: db})); }

    async function getFilesFromRepo(repo) {
        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.username}/${repo}/git/trees/${CONFIG.branch}?recursive=1`);
            const data = await res.json();
            return data.tree ? data.tree.filter(f => f.path.endsWith('.html') && f.path !== 'search.html' && !f.path.includes('index.html')).map(f => {
                const base = repo === `${CONFIG.username}.github.io` ? `https://${CONFIG.username}.github.io/` : `https://${CONFIG.username}.github.io/${repo}/`;
                return { url: base + f.path, repoName: repo }; // L∆∞u th√™m t√™n repo
            }) : [];
        } catch { return []; }
    }

    async function crawlPage(fileObj) {
        try {
            const res = await fetch(fileObj.url);
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            doc.querySelectorAll('script, style, nav, footer').forEach(e => e.remove());
            const title = doc.querySelector('h1')?.innerText || doc.title || fileObj.url;
            const content = doc.body.innerText.replace(/\s+/g, ' ').trim();
            return { 
                title: title.trim(), 
                url: fileObj.url, 
                repo: fileObj.repoName, // G·∫Øn tag repo v√†o d·ªØ li·ªáu
                snippet: content.substring(0, 160) + '...', 
                fullText: (title + content).toLowerCase() 
            };
        } catch { return null; }
    }

    function performSearch(query) {
        const q = query.toLowerCase().trim();
        internalResults.innerHTML = '';
        
        if (q.length < 1) {
            googleSection.style.display = 'none';
            return;
        }

        googleSection.style.display = 'block';

        // G·ªçi Google CSE
        if (window.google && google.search && google.search.cse) {
            const element = google.search.cse.element.getElement('nd-engine');
            if (element) element.execute(q);
        }

        // T√¨m n·ªôi b·ªô (∆Øu ti√™n hi·ªán ·ªü tr√™n)
        const matches = searchDatabase.filter(item => item.fullText.includes(q));
        if (matches.length > 0) {
            matches.forEach(item => {
                const a = document.createElement('a');
                a.className = 'result-item'; a.href = item.url;
                // Th√™m Th·∫ª hi·ªÉn th·ªã t√™n Site (Repo)
                a.innerHTML = `
                    <div class="result-header">
                        <div class="title">${item.title}</div>
                        <span class="site-tag">${item.repo.replace('.github.io', '')}</span>
                    </div>
                    <div class="snippet">${item.snippet}</div>`;
                internalResults.appendChild(a);
            });
        } else {
            internalResults.innerHTML = `
                <div class="sorry-box">
                    <strong>Opps!</strong> Kh√¥ng t√¨m th·∫•y trong kho l∆∞u tr·ªØ ND Labs.<br>
                    M·ªùi b·∫°n xem k·∫øt qu·∫£ t·ª´ Google ·ªü ph√≠a d∆∞·ªõi:
                </div>`;
        }
    }

    async function init() {
        const cachedDb = getCache();
        if (cachedDb) {
            searchDatabase = cachedDb;
        } else {
            document.getElementById('status').innerText = "üöÄ ƒêang qu√©t d·ªØ li·ªáu to√†n h·ªá th·ªëng...";
            let fileList = [];
            for (const repo of CONFIG.repositories) {
                const repoFiles = await getFilesFromRepo(repo);
                fileList = fileList.concat(repoFiles);
            }
            const results = await Promise.all(fileList.map(f => crawlPage(f)));
            searchDatabase = results.filter(r => r !== null);
            setCache(searchDatabase);
        }

        searchInput.disabled = false;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(window.sTimer);
            window.sTimer = setTimeout(() => performSearch(e.target.value), 300);
        });

        const urlQ = new URLSearchParams(window.location.search).get('q');
        if (urlQ) { searchInput.value = urlQ; performSearch(urlQ); }
        document.getElementById('status').innerText = `‚úÖ S·∫µn s√†ng (${searchDatabase.length} n·ªôi dung).`;
    }

    init();
</script>
</body>
</html>
