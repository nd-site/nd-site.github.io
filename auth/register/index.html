<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o NDID - ND Labs</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web" defer></script>
    <link rel="stylesheet" href="/auth/auth.css">
    <script src="/nd-navbar.js" defer></script>
</head>

<body>
    <div class="auth-wrapper">
        <div class="auth-card">
            <div class="auth-header">
                <img src="/logo.png" alt="ND Labs" class="auth-logo">
                <h1>T·∫°o NDID</h1>
                <p>ƒê·ªãnh danh ND duy nh·∫•t, d√πng m√£i m√£i</p>
            </div>

            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="ndid">Ch·ªçn NDID</label>
                    <div class="input-container">
                        <i class="ph-duotone ph-identification-card"></i>
                        <input type="text" id="ndid" placeholder="VD: dang_2026" autocomplete="off" required>
                    </div>
                    <span style="font-size: 12px; color: var(--text-soft); padding-left: 4px;">Ch·ªâ d√πng ch·ªØ th∆∞·ªùng, s·ªë
                        v√† d·∫•u g·∫°ch d∆∞·ªõi. Kh√¥ng th·ªÉ ƒë·ªïi sau khi t·∫°o.</span>
                </div>
                <div class="form-group">
                    <label for="fullname">H·ªç v√† t√™n</label>
                    <div class="input-container">
                        <i class="ph-duotone ph-user"></i>
                        <input type="text" id="fullname" placeholder="T√™n ƒë·∫ßy ƒë·ªß c·ªßa b·∫°n" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="email">Email kh√¥i ph·ª•c</label>
                    <div class="input-container">
                        <i class="ph-duotone ph-envelope-simple"></i>
                        <input type="email" id="email" placeholder="email@gmail.com" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <div class="input-container">
                        <i class="ph-duotone ph-lock"></i>
                        <input type="password" id="password" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" required>
                    </div>
                </div>
                <div
                    style="display: flex; gap: 10px; align-items: flex-start; font-size: 13px; color: var(--text-soft);">
                    <input type="checkbox" id="policy" required style="margin-top: 2px; accent-color: var(--primary);">
                    <label for="policy">T√¥i ƒë·ªìng √Ω v·ªõi <a href="/privacy/"
                            style="color: var(--primary); font-weight: 700;">Ch√≠nh s√°ch b·∫£o m·∫≠t</a> c·ªßa ND Labs</label>
                </div>
                <button type="submit" id="submit-btn" class="btn-primary">
                    <span>Kh·ªüi t·∫°o NDID</span>
                    <i class="ph-bold ph-sparkle"></i>
                </button>
            </form>

            <div class="auth-footer">
                <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="/auth/login/">ƒêƒÉng nh·∫≠p</a></p>
            </div>
        </div>
    </div>

    <div id="status-msg" class="status-msg"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIHXhqSNYhIIozxC5dZ-mTcfXAPzPZgog",
            authDomain: "ndlabs-0.firebaseapp.com",
            projectId: "ndlabs-0",
            storageBucket: "ndlabs-0.firebasestorage.app",
            messagingSenderId: "600040258053",
            appId: "1:600040258053:web:617a19f62aafeb35d13a6c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const form = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusEl = document.getElementById('status-msg');

        function showStatus(text, type) {
            statusEl.textContent = text;
            statusEl.className = `status-msg show ${type}`;
            setTimeout(() => statusEl.className = 'status-msg', 4500);
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.displayName) window.location.href = '/';
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const ndid = document.getElementById('ndid').value.trim().toLowerCase();
            const fullname = document.getElementById('fullname').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (ndid.length < 3) return showStatus('NDID ph·∫£i t·ª´ 3 k√Ω t·ª± tr·ªü l√™n.', 'error');
            if (!/^[a-z0-9_]+$/.test(ndid)) return showStatus('NDID ch·ªâ g·ªìm ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi (_).', 'error');

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>ƒêang kh·ªüi t·∫°o...</span>';

            try {
                // Ki·ªÉm tra NDID ƒë√£ t·ªìn t·∫°i (b·ªè qua n·∫øu Firestore ch∆∞a s·∫µn s√†ng)
                try {
                    const ndidSnap = await getDoc(doc(db, 'ndids', ndid));
                    if (ndidSnap.exists()) {
                        showStatus('NDID n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. H√£y ch·ªçn t√™n kh√°c.', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<span>Kh·ªüi t·∫°o NDID</span><i class="ph-bold ph-sparkle"></i>';
                        return;
                    }
                } catch (fsErr) {
                    console.warn('Firestore ch∆∞a s·∫µn s√†ng, b·ªè qua ki·ªÉm tra NDID:', fsErr.message);
                }

                const internalEmail = `${ndid}@ndlabs.com`;
                const cred = await createUserWithEmailAndPassword(auth, internalEmail, password);
                const user = cred.user;

                await updateProfile(user, { displayName: fullname });

                // L∆∞u v√†o Firestore (b·ªè qua n·∫øu l·ªói)
                try {
                    await setDoc(doc(db, 'ndids', ndid), { uid: user.uid, recoveryEmail: email });
                    await setDoc(doc(db, 'users', user.uid), {
                        ndid, fullname,
                        emails: [email],
                        createdAt: new Date().toISOString()
                    });
                } catch (fsErr) {
                    console.warn('Kh√¥ng th·ªÉ l∆∞u Firestore (s·∫Ω ƒë·ªìng b·ªô sau):', fsErr.message);
                }

                localStorage.setItem('nd_user', JSON.stringify({
                    displayName: fullname, email, photoURL: null, uid: user.uid, ndid
                }));

                showStatus('üéâ T·∫°o NDID th√†nh c√¥ng!', 'success');
                setTimeout(() => window.location.href = '/', 1200);

            } catch (err) {
                console.error(err);
                // D·ªãch l·ªói Firebase sang ti·∫øng Vi·ªát
                const msgs = {
                    'auth/email-already-in-use': 'NDID n√†y ƒë√£ t·ªìn t·∫°i. H√£y ch·ªçn NDID kh√°c ho·∫∑c ƒëƒÉng nh·∫≠p.',
                    'auth/weak-password': 'M·∫≠t kh·∫©u qu√° y·∫øu. C·∫ßn √≠t nh·∫•t 6 k√Ω t·ª±.',
                    'auth/invalid-email': 'ƒê·ªãnh d·∫°ng NDID kh√¥ng h·ª£p l·ªá.',
                    'auth/network-request-failed': 'M·∫•t k·∫øt n·ªëi m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.',
                };
                showStatus(msgs[err.code] || ('L·ªói: ' + err.message), 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Kh·ªüi t·∫°o NDID</span><i class="ph-bold ph-sparkle"></i>';
            }
        });
    </script>
</body>

</html>