import{o as p,g as y,e as d,f as l,a as c,r as f,i as v,j as E,k as w,u as m,l as r,E as L,m as I,G as B,n as k,p as C,b}from"./firebase-MFGuTdBG.js";const u=document.getElementById("user-avatar"),D=document.getElementById("avatar-upload"),h=document.getElementById("display-name"),R=document.getElementById("display-email"),U=document.getElementById("ndid-display"),g=document.getElementById("edit-name"),x=document.getElementById("profile-form"),i=document.getElementById("link-google-btn"),G=document.getElementById("logout-btn"),s=document.getElementById("reauth-modal"),N=document.getElementById("reauth-password"),P=document.getElementById("confirm-reauth"),A=document.getElementById("cancel-reauth");let e=null;p(c,async t=>{if(!t){localStorage.removeItem("nd_user"),window.location.href="/auth/login";return}e=t,h.textContent=t.displayName||"ND Member";const a=await y(d(l,"users",t.uid));if(a.exists()){const n=a.data();R.textContent=n.emails?.[0]||t.email,U.textContent=n.ndid||"Chưa thiết lập",g.value=n.fullname||t.displayName||""}t.photoURL&&(u.src=t.photoURL),t.providerData.some(n=>n.providerId==="google.com")&&(i.textContent="Đã liên kết Google",i.disabled=!0)});D.addEventListener("change",async t=>{const a=t.target.files[0];if(!(!a||!e))try{const o=f(v,`avatars/${e.uid}`);await E(o,a);const n=await w(o);await m(e,{photoURL:n}),u.src=n,await r(d(l,"users",e.uid),{photoURL:n}),alert("Cập nhật ảnh đại diện thành công!")}catch(o){console.error(o),alert("Lỗi khi tải ảnh lên.")}});x.addEventListener("submit",async t=>{if(t.preventDefault(),!!e)try{const a=g.value.trim();await m(e,{displayName:a}),await r(d(l,"users",e.uid),{fullname:a}),h.textContent=a,alert("Cập nhật thông tin thành công!")}catch{alert("Lỗi khi lưu thông tin.")}});i.addEventListener("click",()=>{s.classList.remove("hidden")});A.addEventListener("click",()=>{s.classList.add("hidden")});P.addEventListener("click",async()=>{const t=N.value;if(!t||!e)return;const a=L.credential(e.email,t);try{await I(e,a),s.classList.add("hidden");const o=new B;await k(e,o),i.textContent="Đã liên kết Google",i.disabled=!0,e.email&&await r(d(l,"users",e.uid),{emails:C(e.providerData.find(n=>n.providerId==="google.com")?.email)}),alert("Liên kết thành công!")}catch(o){alert("Xác thực thất bại: "+o.message)}});G.addEventListener("click",async()=>{await b(c),localStorage.removeItem("nd_user"),window.location.href="/"});
