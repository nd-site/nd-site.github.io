import{o as L,g as I,d as c,c as m,a as f,r as B,h as k,i as N,j as C,u as v,k as g,E as x,l as R,G as U,m as S,n as b,p as D}from"./firebase-DLphYnwd.js";const E=document.getElementById("user-avatar"),G=document.getElementById("avatar-upload"),w=document.getElementById("display-name"),p=document.getElementById("display-email"),y=document.getElementById("ndid-display"),u=document.getElementById("edit-name"),P=document.getElementById("profile-form"),l=document.getElementById("link-google-btn"),_=document.getElementById("logout-btn"),h=document.getElementById("reauth-modal"),A=document.getElementById("reauth-password"),M=document.getElementById("confirm-reauth"),O=document.getElementById("cancel-reauth");let a=null;const d=document.createElement("div");d.className="status-msg";document.body.appendChild(d);function i(t,e){d.textContent=t,d.className=`status-msg show ${e}`,setTimeout(()=>{d.className="status-msg"},4e3)}L(f,async t=>{if(!t){localStorage.removeItem("nd_user"),window.location.href="/auth/login/";return}a=t,w.textContent=t.displayName||"ND Member";const e=await I(c(m,"users",t.uid));if(e.exists()){const s=e.data();p.textContent=s.emails?.[0]||t.email,y.textContent=s.ndid||t.email?.split("@")[0]||"",u.value=s.fullname||t.displayName||""}else y.textContent=t.email?.split("@")[0]||"",p.textContent=t.email||"",u.value=t.displayName||"";t.photoURL&&(E.src=t.photoURL),t.providerData.some(s=>s.providerId==="google.com")&&(l.textContent="Đã liên kết Google",l.disabled=!0);const o=localStorage.getItem("nd_user"),r=o?JSON.parse(o):{};localStorage.setItem("nd_user",JSON.stringify({...r,displayName:t.displayName,email:t.email,photoURL:t.photoURL,uid:t.uid}))});G.addEventListener("change",async t=>{const e=t.target.files[0];if(!(!e||!a))try{const n=B(k,`avatars/${a.uid}`);await N(n,e);const o=await C(n);await v(a,{photoURL:o}),E.src=o,await g(c(m,"users",a.uid),{photoURL:o}),i("Cập nhật ảnh đại diện thành công!","success")}catch(n){console.error(n),i("Lỗi khi tải ảnh lên.","error")}});P.addEventListener("submit",async t=>{if(t.preventDefault(),!!a)try{const e=u.value.trim();await v(a,{displayName:e});try{await g(c(m,"users",a.uid),{fullname:e})}catch{}w.textContent=e,i("Cập nhật thành công!","success")}catch{i("Lỗi khi lưu thông tin.","error")}});l.addEventListener("click",()=>{h.classList.remove("hidden")});O.addEventListener("click",()=>{h.classList.add("hidden")});M.addEventListener("click",async()=>{const t=A.value;if(!t||!a)return;const e=x.credential(a.email,t);try{await R(a,e),h.classList.add("hidden");const n=new U,o=await S(a,n);l.textContent="Đã liên kết Google",l.disabled=!0;const r=o.user.providerData.find(s=>s.providerId==="google.com")?.email;if(r)try{await g(c(m,"users",a.uid),{emails:b(r)})}catch{}i("Liên kết Google thành công!","success")}catch(n){i("Lỗi: "+n.message,"error")}});_.addEventListener("click",async()=>{await D(f),localStorage.removeItem("nd_user"),window.location.href="/"});
