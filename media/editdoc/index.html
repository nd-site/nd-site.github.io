<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditDoc Pro by ND Labs - Chuyển đổi PDF Đa Năng</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- LIBRARIES -->
    <!-- 1. PDF.js: Đọc và phân tích PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- 2. PptxGenJS: Tạo file PowerPoint -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <script>
        // Cấu hình Worker cho PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .drop-zone {
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        .drop-zone.active {
            background-color: #eff6ff;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233B82F6FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        @keyframes pulse-blue {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse-blue {
            animation: pulse-blue 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <script src="/nd-navbar.js" defer></script></head>

<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-10 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="/logo.png" onerror="this.src='https://placehold.co/40x40/3b82f6/white?text=ND'"
                    alt="ND Labs Logo" class="h-10 w-10 object-contain rounded-md">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 tracking-tight">EditDoc <span
                            class="text-blue-600">Pro</span></h1>
                    <p class="text-xs text-gray-500 font-medium">by ND Labs</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center bg-gray-100 rounded-lg p-1 mr-4">
                    <button onclick="app.undo()" id="btn-undo"
                        class="p-2 rounded-md hover:bg-white hover:shadow-sm text-gray-500 hover:text-gray-700 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        title="Hoàn tác (Ctrl+Z)">
                        <i class="ph ph-arrow-u-up-left text-lg"></i>
                    </button>
                    <div class="w-px h-4 bg-gray-300 mx-1"></div>
                    <button onclick="app.redo()" id="btn-redo"
                        class="p-2 rounded-md hover:bg-white hover:shadow-sm text-gray-500 hover:text-gray-700 disabled:opacity-40 disabled:cursor-not-allowed transition"
                        title="Làm lại (Ctrl+Shift+Z)">
                        <i class="ph ph-arrow-u-up-right text-lg"></i>
                    </button>
                </div>
                <a href="/index.html"
                    class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium transition text-sm">
                    <i class="ph ph-house text-lg"></i>
                    <span>Trang chủ</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-4 sm:p-6 lg:p-8 flex flex-col items-center">
        <div class="w-full max-w-4xl space-y-8">
            <div class="text-center space-y-2">
                <h2 class="text-3xl font-bold text-gray-900">Chuyển đổi PDF nâng cao</h2>
                <p class="text-gray-500">Phân tích bố cục và xuất ra file Word, PowerPoint, Ảnh chất lượng cao.</p>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div
                    class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
                        <span class="text-gray-500">Định dạng đích:</span>
                        <select id="format-select"
                            class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 pl-3 pr-8 outline-none cursor-pointer font-semibold">
                            <option value="docx" selected>📄 Word (.docx) - Giữ nguyên Layout</option>
                            <option value="pptx">📊 PowerPoint (.pptx) - Giữ bố cục</option>
                            <option value="jpg">🖼️ Ảnh (.jpg) - Chất lượng cao</option>
                        </select>
                    </div>
                    <div
                        class="flex items-center gap-2 text-xs text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">
                        <i class="ph ph-magic-wand"></i>
                        <span id="ai-status">Phân tích tọa độ thông minh</span>
                    </div>
                </div>

                <div class="p-6 sm:p-8">
                    <div id="drop-zone"
                        class="drop-zone relative rounded-2xl h-64 flex flex-col items-center justify-center text-center cursor-pointer group">
                        <input type="file" id="file-input"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".pdf" multiple>
                        <div
                            class="bg-blue-50 p-4 rounded-full mb-4 group-hover:scale-110 transition-transform duration-200">
                            <i class="ph ph-file-pdf text-4xl text-blue-600"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Kéo thả file PDF vào đây</h3>
                        <p class="text-gray-500 text-sm mb-4">Hỗ trợ phân tích thành phần giống WPS</p>
                        <span
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg shadow-md shadow-blue-200 group-hover:bg-blue-700 transition">
                            Chọn tài liệu
                        </span>
                    </div>

                    <div id="file-list-container" class="mt-8 hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wider">Danh sách tệp</h3>
                            <button onclick="app.clearAll()"
                                class="text-xs text-red-500 hover:text-red-700 font-medium hover:underline">Xóa tất
                                cả</button>
                        </div>
                        <div id="file-list" class="space-y-3"></div>

                        <div class="mt-6 flex justify-end">
                            <button onclick="app.startConversion()" id="convert-btn"
                                class="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg shadow-blue-200 transition active:scale-95">
                                <i class="ph ph-arrows-left-right"></i>
                                Phân tích & Chuyển đổi
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center sm:text-left">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i
                            class="ph ph-microsoft-word-logo text-xl"></i></div>
                    <div>
                        <p class="font-semibold text-sm text-gray-900">Word chính xác</p>
                        <p class="text-xs text-gray-500">Giữ nguyên vị trí chữ</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3">
                    <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i
                            class="ph ph-microsoft-powerpoint-logo text-xl"></i></div>
                    <div>
                        <p class="font-semibold text-sm text-gray-900">PowerPoint chuẩn</p>
                        <p class="text-xs text-gray-500">Giữ nguyên 100% bố cục</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3">
                    <div class="bg-green-100 p-2 rounded-lg text-green-600"><i class="ph ph-shield-check text-xl"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-sm text-gray-900">An toàn tuyệt đối</p>
                        <p class="text-xs text-gray-500">Xử lý 100% trên trình duyệt</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm text-gray-500">© 2026 ND Labs. All rights reserved.</p>
        </div>
    </footer>

    <script>
        class EditDocApp {
            constructor() {
                this.files = [];
                this.history = [];
                this.historyIndex = -1;
                this.targetFormat = 'docx';

                this.dropZone = document.getElementById('drop-zone');
                this.fileInput = document.getElementById('file-input');
                this.fileListContainer = document.getElementById('file-list-container');
                this.fileListEl = document.getElementById('file-list');
                this.formatSelect = document.getElementById('format-select');
                this.btnUndo = document.getElementById('btn-undo');
                this.btnRedo = document.getElementById('btn-redo');
                this.aiStatus = document.getElementById('ai-status');

                this.init();
            }

            init() {
                this.saveState();
                this.fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
                this.formatSelect.addEventListener('change', (e) => {
                    this.targetFormat = e.target.value;
                    this.updateStatusText();
                    this.render();
                });
                this.dropZone.addEventListener('dragenter', (e) => { e.preventDefault(); this.dropZone.classList.add('active'); });
                this.dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); this.dropZone.classList.remove('active'); });
                this.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });
                this.dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dropZone.classList.remove('active');
                    this.handleFiles(e.dataTransfer.files);
                });
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) { this.redo(); } else { this.undo(); }
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') {
                        e.preventDefault();
                        this.redo();
                    }
                });
                this.updateButtons();
            }

            updateStatusText() {
                const map = {
                    'docx': 'Phân tích tọa độ & giữ Layout',
                    'pptx': 'Render slide & đóng gói',
                    'jpg': 'Render ảnh chất lượng cao'
                };
                this.aiStatus.innerText = map[this.targetFormat] || 'Sẵn sàng';
            }

            handleFiles(fileList) {
                const validFiles = Array.from(fileList).filter(file => file.type === 'application/pdf');
                if (validFiles.length < fileList.length) this.showToast('Chỉ hỗ trợ file PDF', 'error');
                const newFiles = validFiles.map(file => ({
                    id: Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    size: this.formatSize(file.size),
                    status: 'ready',
                    progress: 0,
                    statusText: 'Chờ xử lý',
                    fileData: file,
                    downloadUrl: null,
                    resultName: null
                }));
                this.files = [...this.files, ...newFiles];
                this.saveState();
                this.render();
            }

            async startConversion() {
                if (this.files.length === 0) return;
                const btn = document.getElementById('convert-btn');
                btn.disabled = true;
                btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Đang phân tích...`;
                for (let file of this.files) {
                    if (file.status === 'ready') {
                        file.status = 'analyzing';
                        this.render();
                        try {
                            await this.processFile(file);
                            file.status = 'done';
                            file.progress = 100;
                            file.statusText = 'Hoàn tất';
                        } catch (err) {
                            console.error(err);
                            file.status = 'error';
                            file.statusText = 'Lỗi';
                            this.showToast(`Lỗi: ${err.message}`, 'error');
                        }
                        this.render();
                    }
                }
                btn.disabled = false;
                btn.innerHTML = `<i class="ph ph-arrows-left-right"></i> Chuyển đổi lại`;
                if (this.files.every(f => f.status === 'done')) this.showToast('Đã đóng gói xong!', 'info');
            }

            async processFile(fileObj) {
                fileObj.statusText = 'Đang đọc PDF...';
                this.render();
                const arrayBuffer = await fileObj.fileData.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                if (this.targetFormat === 'docx') {
                    await this.convertPdfToDocx(fileObj, pdf);
                } else if (this.targetFormat === 'pptx') {
                    await this.convertPdfToPptx(fileObj, pdf);
                } else {
                    await this.convertPdfToJpg(fileObj, pdf);
                }
            }

            // --- ENGINE 1: PDF to DOCX (Phân tích Layout Chính xác) ---
            async convertPdfToDocx(fileObj, pdf) {
                let fullHtml = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'><title>Doc Export</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; }
                        .page { position: relative; width: 595pt; height: 842pt; page-break-after: always; overflow: hidden; }
                        .text-block { position: absolute; white-space: nowrap; line-height: 1.2; }
                    </style>
                        <script src="/nd-navbar.js" defer></script></head><body>`;

                const totalPages = pdf.numPages;

                for (let i = 1; i <= totalPages; i++) {
                    fileObj.statusText = `Phân tích layout trang ${i}/${totalPages}...`;
                    fileObj.progress = Math.floor(((i - 1) / totalPages) * 100);
                    this.renderProgress(fileObj.id, fileObj.progress);

                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.0 });
                    const textContent = await page.getTextContent();

                    fullHtml += `<div class="page" style="width: ${viewport.width}pt; height: ${viewport.height}pt;">`;

                    textContent.items.forEach(item => {
                        const tx = item.transform; // [scaleX, skewX, skewY, scaleY, translateX, translateY]
                        const x = tx[4];
                        const y = viewport.height - tx[5] - (tx[3] || 12); // Chuyển đổi tọa độ PDF sang HTML
                        const fontSize = Math.sqrt(tx[0] * tx[0] + tx[1] * tx[1]); // Độ lớn font thực tế

                        fullHtml += `<div class="text-block" style="left: ${x}pt; top: ${y}pt; font-size: ${fontSize}pt;">${item.str}</div>`;
                    });

                    fullHtml += `</div>`;
                }

                fullHtml += "</body></html>";
                const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
                fileObj.downloadUrl = URL.createObjectURL(blob);
                fileObj.resultName = fileObj.name.replace('.pdf', '.doc');
            }

            async convertPdfToPptx(fileObj, pdf) {
                let pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_16x9';
                const totalPages = pdf.numPages;
                for (let i = 1; i <= totalPages; i++) {
                    fileObj.statusText = `Đang render slide ${i}/${totalPages}...`;
                    fileObj.progress = Math.floor(((i - 1) / totalPages) * 100);
                    this.renderProgress(fileObj.id, fileObj.progress);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);
                    let slide = pptx.addSlide();
                    slide.addImage({ data: imgData, x: 0, y: 0, w: '100%', h: '100%', sizing: { type: 'contain', w: '100%', h: '100%' } });
                }
                fileObj.statusText = 'Đang đóng gói PPTX...';
                const blob = await pptx.write("blob");
                fileObj.downloadUrl = URL.createObjectURL(blob);
                fileObj.resultName = fileObj.name.replace('.pdf', '.pptx');
            }

            async convertPdfToJpg(fileObj, pdf) {
                fileObj.statusText = 'Đang render ảnh...';
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                fileObj.downloadUrl = URL.createObjectURL(blob);
                fileObj.resultName = fileObj.name.replace('.pdf', '.jpg');
            }

            renderProgress(id, percent) {
                const bar = document.getElementById(`progress-${id}`);
                if (bar) bar.style.width = `${percent}%`;
            }

            render() {
                if (this.files.length === 0) { this.fileListContainer.classList.add('hidden'); return; }
                this.fileListContainer.classList.remove('hidden');
                this.fileListEl.innerHTML = '';
                this.files.forEach(file => {
                    let actionHtml = '';
                    let statusHtml = '';
                    let iconColor = 'text-red-500';
                    if (file.status === 'ready') {
                        actionHtml = `<button onclick="app.removeFile('${file.id}')" class="p-2 text-gray-400 hover:text-red-500 transition"><i class="ph ph-trash text-lg"></i></button>`;
                        statusHtml = `<span class="text-xs text-gray-400">Sẵn sàng</span>`;
                    } else if (file.status === 'analyzing') {
                        actionHtml = `<div class="w-32 flex flex-col gap-1">
                            <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden"><div id="progress-${file.id}" class="h-full bg-blue-500 transition-all duration-300" style="width: ${file.progress}%"></div></div>
                            <span id="status-text-${file.id}" class="text-[10px] text-blue-600 font-medium truncate animate-pulse">${file.statusText}</span>
                         </div>`;
                        iconColor = 'text-blue-500 animate-pulse-blue';
                    } else if (file.status === 'done' && file.downloadUrl) {
                        iconColor = 'text-green-500';
                        statusHtml = `<span class="text-xs text-green-600 font-medium">Hoàn tất</span>`;
                        actionHtml = `<a href="${file.downloadUrl}" download="${file.resultName}" class="flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition shadow-sm shadow-green-200"><i class="ph ph-download-simple"></i> Tải về</a>`;
                    } else if (file.status === 'error') {
                        statusHtml = `<span class="text-xs text-red-500 font-medium">Lỗi</span>`;
                        actionHtml = `<button onclick="app.removeFile('${file.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded"><i class="ph ph-x"></i></button>`;
                    }
                    const html = `
                        <div class="flex items-center justify-between p-4 bg-white border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition group">
                            <div class="flex items-center gap-4 overflow-hidden flex-1">
                                <div class="bg-gray-50 p-2 rounded-lg group-hover:bg-blue-50 transition">
                                    <i class="ph ph-file-pdf ${iconColor} text-2xl"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                                    <div class="flex items-center gap-2 mt-0.5">
                                        <span class="text-xs text-gray-400">${file.size}</span>
                                        ${file.status !== 'analyzing' ? statusHtml : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0 ml-4">${actionHtml}</div>
                        </div>`;
                    this.fileListEl.insertAdjacentHTML('beforeend', html);
                });
            }

            saveState() {
                const stateSnapshot = this.files.map(f => ({ ...f, fileData: null, downloadUrl: null }));
                if (this.historyIndex < this.history.length - 1) this.history = this.history.slice(0, this.historyIndex + 1);
                this.history.push(stateSnapshot);
                this.historyIndex++;
                this.updateButtons();
            }
            undo() { if (this.historyIndex > 0) { this.historyIndex--; this.restoreState(); } }
            redo() { if (this.historyIndex < this.history.length - 1) { this.historyIndex++; this.restoreState(); } }
            restoreState() {
                const savedState = this.history[this.historyIndex];
                this.files = savedState.map(savedFile => {
                    const existingFile = this.files.find(f => f.id === savedFile.id);
                    return { ...savedFile, fileData: existingFile ? existingFile.fileData : null, status: (existingFile && existingFile.fileData) ? savedFile.status : 'expired' };
                });
                this.render(); this.updateButtons();
            }
            updateButtons() { this.btnUndo.disabled = this.historyIndex <= 0; this.btnRedo.disabled = this.historyIndex >= this.history.length - 1; }
            removeFile(id) { this.files = this.files.filter(f => f.id !== id); this.saveState(); this.render(); }
            clearAll() { this.files = []; this.saveState(); this.render(); }
            formatSize(bytes) { if (bytes === 0) return '0 B'; const k = 1024; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i]; }
            showToast(msg, type = 'info') {
                const t = document.createElement('div'); t.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300 translate-y-10 opacity-0 z-50 flex items-center gap-2 ${type === 'info' ? 'bg-gray-800' : 'bg-red-500'}`;
                t.innerHTML = `<i class="ph ph-${type === 'info' ? 'info' : 'warning-circle'}"></i> ${msg}`; document.body.appendChild(t);
                setTimeout(() => t.classList.remove('translate-y-10', 'opacity-0'), 10);
                setTimeout(() => { t.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => t.remove(), 300); }, 3000);
            }
        }
        const app = new EditDocApp();
    </script>
</body>

</html>