<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vòng quay may mắn - Nhật Đăng</title>
  <link rel="icon" href="/logo.png" type="image/png">
  <style>
    :root{--bg:#fcfdff}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e6f0ff,#fff0f5);padding:24px}
    .wrap{width:920px;max-width:100%;display:grid;grid-template-columns:360px 1fr;gap:18px;align-items:start}
    .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(20,20,30,0.08)}
    textarea{width:100%;height:240px;border:1px solid #eee;padding:10px;border-radius:8px;resize:vertical;font-size:15px}
    .controls{display:flex;gap:8px;margin-top:10px}
    button{padding:10px 14px;border-radius:8px;border:0;background:linear-gradient(90deg,#6ec6ff,#a37bff);color:white;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid #ddd;color:#333}
    canvas{background:transparent;display:block;margin:auto}
    .topline{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .result{margin-top:12px;text-align:center;font-weight:700;font-size:18px}
    .wheel-wrap{display:flex;align-items:center;justify-content:center;padding:20px}
    .pointer{position:relative;height:28px}
    .pointer:after{content:'';position:absolute;left:50%;transform:translateX(-50%);top:-6px;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid #ff4d4f;border-radius:2px}
    @media (max-width:880px){.wrap{grid-template-columns:1fr}textarea{height:180px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topline">
        <strong>Nhập tên (mỗi tên 1 dòng)</strong>
        <div style="font-size:13px;color:#666">Mã màu và ô sinh ra tự động</div>
      </div>
      <textarea id="names" placeholder="Ví dụ:\nNguyễn Văn A\nTrần Thị B\nLê C"></textarea>
      <div class="controls">
        <button id="spinBtn">Quay</button>
        <button id="randBtn" class="secondary">Tạo màu mới</button>
        <button id="clearBtn" class="secondary">Xóa</button>
      </div>
      <div class="result" id="result">Chưa quay</div>
    </div>

    <div class="card" style="display:flex;flex-direction:column;align-items:center;">
      <div class="wheel-wrap">
        <div style="text-align:center;width:540px;">
          <div class="pointer"></div>
          <canvas id="wheel" width="540" height="540"></canvas>
        </div>
      </div>
      <div style="width:100%;display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:8px" id="legend"></div>
    </div>
  </div>

<script>
/* Vòng quay may mắn
 - Nhập tên mỗi dòng -> tự tạo ô và màu random cho từng ô
 - Khi thay đổi input (thêm/xóa/dòng mới) sẽ tạo màu mới cho tất cả ô
 - Nhấn Quay để quay và chọn ngẫu nhiên
*/
const $names = document.getElementById('names')
const $wheel = document.getElementById('wheel')
const ctx = $wheel.getContext('2d')
const $spin = document.getElementById('spinBtn')
const $rand = document.getElementById('randBtn')
const $clear = document.getElementById('clearBtn')
const $result = document.getElementById('result')
const $legend = document.getElementById('legend')
let entries = []
let colors = []
let rotation = 0 // current rotation angle (rad)
let isSpinning = false
let spinAnim = null

function parseNames(text){
  return text.split('\n').map(s=>s.trim()).filter(s=>s.length>0)
}

function randColor(i){
  // HSL distribution for nice contrast
  const hue = Math.floor(Math.random()*360)
  const sat = 70 + Math.floor(Math.random()*10)
  const light = 50 + Math.floor(Math.random()*8)
  return `hsl(${hue} ${sat}% ${light}%)`
}

function rebuild(){
  entries = parseNames($names.value)
  if(entries.length === 0){
    colors = []
    drawWheel()
    renderLegend()
    $result.textContent = 'Chưa quay'
    return
  }
  // recreate colors for ALL slices (the user asked: nếu xuống dòng và nhập tên khác sẽ tạo thêm ô và màu random cho tất cả các ô)
  colors = entries.map((_,i)=>randColor(i))
  drawWheel()
  renderLegend()
}

function renderLegend(){
  $legend.innerHTML = ''
  entries.forEach((name,i)=>{
    const item = document.createElement('div')
    item.style.display = 'flex'
    item.style.gap = '8px'
    item.style.alignItems = 'center'
    item.style.padding = '6px 8px'
    item.style.borderRadius = '8px'
    item.style.border = '1px solid #f0f0f0'
    item.style.fontSize = '13px'
    item.innerHTML = `<div style="width:28px;height:14px;border-radius:4px;background:${colors[i]};box-shadow:inset 0 -2px 0 rgba(0,0,0,0.05)"></div><div style="min-width:120px;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(name)}</div>`
    $legend.appendChild(item)
  })
}

function escapeHtml(s){return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

function drawWheel(){
  const dpr = window.devicePixelRatio || 1
  const size = Math.min(540, Math.max(360, Math.floor(window.innerWidth*0.45)))
  $wheel.width = size * dpr
  $wheel.height = size * dpr
  $wheel.style.width = size + 'px'
  $wheel.style.height = size + 'px'
  ctx.setTransform(dpr,0,0,dpr,0,0)

  ctx.clearRect(0,0,$wheel.width,$wheel.height)
  const cx = size/2, cy = size/2, r = Math.min(cx,cy)-8
  const n = entries.length || 1
  const slice = (Math.PI*2)/n

  // draw slices
  for(let i=0;i<n;i++){
    const start = rotation + i*slice
    const end = start + slice
    ctx.beginPath()
    ctx.moveTo(cx,cy)
    ctx.arc(cx,cy,r,start,end)
    ctx.closePath()
    ctx.fillStyle = colors[i] || '#eee'
    ctx.fill()
    ctx.strokeStyle = 'rgba(255,255,255,0.06)'
    ctx.lineWidth = 1
    ctx.stroke()

    // label
    ctx.save()
    const ang = start + slice/2
    ctx.translate(cx,cy)
    ctx.rotate(ang)
    ctx.textAlign = 'right'
    ctx.fillStyle = '#111'
    ctx.font = 'bold 14px system-ui'
    // position label a bit inside
    const labelX = r - 12
    wrapText(ctx, entries[i] || '', labelX, -6, 120, 14)
    ctx.restore()
  }

  // center circle
  ctx.beginPath()
  ctx.arc(cx,cy,40,0,Math.PI*2)
  ctx.fillStyle = '#fff'
  ctx.fill()
  ctx.strokeStyle = 'rgba(0,0,0,0.06)'
  ctx.stroke()
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  // draw text right-to-left along radial direction
  const words = text.split(' ')
  let line = ''
  let lines = []
  for (let n = 0; n < words.length; n++) {
    const testLine = line + (line? ' ' : '') + words[n]
    const testWidth = ctx.measureText(testLine).width
    if (testWidth > maxWidth && n > 0) {
      lines.push(line)
      line = words[n]
    } else {
      line = testLine
    }
  }
  lines.push(line)
  for(let i=0;i<lines.length;i++){
    ctx.fillText(lines[i], x, y + i*lineHeight)
  }
}

// spin logic
function spin(){
  if(isSpinning || entries.length===0) return
  isSpinning = true
  $spin.disabled = true
  $result.textContent = 'Đang quay...'

  const n = entries.length
  const extraRounds = 3 + Math.floor(Math.random()*4)
  // random target index
  const target = Math.floor(Math.random()*n)
  const slice = (Math.PI*2)/n
  // compute final rotation so that pointer (at top) lands on target slice
  // pointer angle relative to wheel = -Math.PI/2
  const pointerAngle = -Math.PI/2
  // we want rotation + target*slice + slice/2 to equal pointerAngle (mod 2pi)
  const desired = pointerAngle - (target*slice + slice/2)
  const current = rotation % (Math.PI*2)
  // choose smallest positive delta plus extraRounds
  let delta = desired - current
  delta = ((delta % (Math.PI*2)) + (Math.PI*2)) % (Math.PI*2)
  const total = delta + extraRounds*(Math.PI*2)

  const duration = 4200 + Math.random()*1200
  const start = performance.now()
  const startRot = rotation
  function step(t){
    const p = Math.min(1,(t-start)/duration)
    // easing out cubic
    const ease = 1 - Math.pow(1-p,3)
    rotation = startRot + total*ease
    drawWheel()
    if(p<1){
      spinAnim = requestAnimationFrame(step)
    } else {
      isSpinning = false
      $spin.disabled = false
      const final = (rotation + (2*Math.PI)) % (2*Math.PI)
      // compute selected
      const index = indexFromAngle(final)
      $result.textContent = entries[index] ? `Trúng: ${entries[index]}` : 'Không xác định'
      // give visual flash on legend
      flashLegend(index)
    }
  }
  spinAnim = requestAnimationFrame(step)
}

function indexFromAngle(angle){
  // pointer at -PI/2, so compute which slice contains that angle
  const n = entries.length
  const slice = (2*Math.PI)/n
  // angle of slice 0 start = rotation
  // we need the slice at pointerAngle
  const pointer = (-Math.PI/2 - angle + 2*Math.PI) % (2*Math.PI)
  let idx = Math.floor(pointer / slice)
  idx = ((idx % n) + n) % n
  return idx
}

function flashLegend(i){
  const children = Array.from($legend.children)
  children.forEach((c,idx)=>{
    c.style.transition = 'transform 240ms ease, box-shadow 240ms'
    if(idx===i){
      c.style.transform = 'scale(1.04)'
      c.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)'
      setTimeout(()=>{c.style.transform='';c.style.boxShadow=''},1200)
    }
  })
}

// utilities
$names.addEventListener('input',()=>{
  rebuild()
})
$spin.addEventListener('click', spin)
$rand.addEventListener('click', ()=>{ if(entries.length){ colors = entries.map((_,i)=>randColor(i)); drawWheel(); renderLegend(); }})
$clear.addEventListener('click', ()=>{ $names.value=''; rebuild(); })

window.addEventListener('resize', ()=> drawWheel())

// initial sample
$names.value = 'Nguyễn Văn A\nTrần Thị B\nLê C\nChâu D'
rebuild()
</script>
    <!-- Đặt ở cuối body -->
  <div class="home-wrapper">
    <!-- Nút Trang Chủ -->
    <a href="https://nd-site.github.io" class="home-btn">
      <img src="/homebtn.png" alt="Trang chủ">
    </a>

    <style>
      .home-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 55px;
        height: 55px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 9999;
        animation: float 3s ease-in-out infinite;
        text-decoration: none;
      }
      .home-btn img {
        max-width: 60%;
        max-height: 60%;
        object-fit: contain;
      }
      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-6px); }
      }
      .home-btn:hover {
        transform: scale(1.05);
        transition: 0.3s;
      }
    </style>
  </div>
</body>
</html>
